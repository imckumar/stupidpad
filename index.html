<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Very Stupid Notepad (Stupidpad)</title>
<style>
  :root{
    --bg-primary:#1e1e1e;--bg-secondary:#252526;--bg-tertiary:#2d2d30;
    --text-primary:#cccccc;--text-secondary:#969696;--border:#3e3e42;
    --accent:#007acc;--accent-hover:#1177bb;--error:#f44336
  }
  body{margin:0;display:flex;height:100vh;font-family:Consolas,Monaco,'Courier New',monospace;background:var(--bg-primary);color:var(--text-primary);flex-direction:column}
  body.light-theme{--bg-primary:#ffffff;--bg-secondary:#f8f8f8;--bg-tertiary:#eeeeee;--text-primary:#333333;--text-secondary:#666666;--border:#d0d0d0}

  #toolbar{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:12px}
  #toolbar button,#toolbar select,#toolbar input[type=number]{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);padding:4px 8px;border-radius:3px;cursor:pointer;font:inherit}
  #toolbar button:hover{background:var(--accent)}
  .separator{width:1px;height:20px;background:var(--border);margin:0 4px}
  .file-input-wrapper{position:relative;overflow:hidden;display:inline-block}
  .file-input-wrapper input[type=file]{position:absolute;left:-9999px}
  .file-input-label{padding:4px 8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:3px;cursor:pointer;font-size:12px}
  .file-input-label:hover{background:var(--accent)}

  #main{display:flex;flex:1;overflow:hidden}
  #editor{flex:1;display:flex;flex-direction:column;position:relative}
  #editorArea{display:flex;flex:1;overflow:hidden}
  #panesContainer{display:flex;flex:1;overflow:hidden;gap:0;flex-direction:row}

  .pane{display:flex;position:relative;flex:1 1 0;min-width:220px;border-right:1px solid var(--border)}
  .pane:last-child{border-right:none}

  .gutter{
    width:50px;background:var(--bg-secondary);color:var(--text-secondary);text-align:right;
    padding:10px 8px 10px 4px;font:inherit;white-space:normal;
    overflow:hidden;user-select:none;border-right:1px solid var(--border);box-sizing:border-box
  }
  .gutter .line-number{display:block}
  .gutter .line-number.current-line{background:var(--bg-tertiary);color:var(--text-primary);font-weight:600}

  textarea{flex:1;font:inherit;padding:10px;border:none;outline:none;resize:none;background:var(--bg-primary);
    color:var(--text-primary);white-space:pre-wrap;word-wrap:break-word;overflow:auto;tab-size:3;line-height:1.5}
  textarea::selection{background:var(--accent);color:#fff}

  .current-line-highlight{position:absolute;left:50px;right:0;background:rgba(255,255,255,.06);pointer-events:none;z-index:2;height:0;display:none}

  .resizer{width:6px;cursor:col-resize;background:transparent;position:relative}
  .resizer::after{content:'';position:absolute;top:0;bottom:0;left:2px;width:2px;background:var(--border);opacity:.8}
  .resizer.vertical{height:6px;width:100%;cursor:row-resize}
  .resizer.vertical::after{top:2px;left:0;right:0;height:2px;width:100%}

  #tools{width:300px;background:var(--bg-secondary);color:var(--text-primary);padding:15px;box-sizing:border-box;border-left:1px solid var(--border);overflow-y:auto}
  #tools h3{margin:0 0 10px;font-size:14px;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:5px}
  #tools label{display:block;margin-top:10px;font-size:12px}
  #tools input[type=text],#tools input[type=number],#tools select{width:100%;padding:6px;margin-top:3px;box-sizing:border-box;font-size:12px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:3px}
  #tools button{margin-top:8px;padding:6px 10px;border:1px solid var(--border);background:var(--bg-tertiary);color:var(--text-primary);cursor:pointer;border-radius:3px;font-size:12px}
  #tools button:hover{background:var(--accent)}

  #tabBar{
    display:flex;background:var(--bg-secondary);
    border-top:1px solid var(--border);
    padding:2px 6px 0;
    overflow-x:auto;min-height:28px;
  }
  .tab{
    padding:4px 8px;background:var(--bg-tertiary);margin-right:4px;border-radius:6px 6px 0 0;cursor:pointer;display:flex;align-items:center;
    user-select:none;border:1px solid var(--border);border-bottom:none;transition:all .2s ease;
    font-size:12px;color:var(--text-secondary);min-width:80px;max-width:200px;height:24px;
  }
  .tab:hover{background:var(--bg-primary);color:var(--text-primary)}
  .tab.active{background:var(--bg-primary);color:var(--text-primary);font-weight:500;border-color:var(--accent)}
  .tab .tab-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:6px}
  .tab .close-btn{
    margin-left:6px;color:var(--text-secondary);cursor:pointer;width:14px;height:14px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;line-height:1;transition:all .2s ease;flex-shrink:0
  }
  .tab .close-btn:hover{background:var(--error);color:#fff}
  #addTab{
    background:var(--accent);color:#fff;font-weight:bold;padding:4px 8px;cursor:pointer;border-radius:6px 6px 0 0;display:flex;align-items:center;justify-content:center;
    font-size:14px;min-width:26px;border:1px solid var(--accent);border-bottom:none;transition:all .2s ease;height:24px
  }
  #addTab:hover{background:var(--accent-hover)}
  .tab input.tab-rename{user-select:text;height:20px;padding:1px 6px}

  #statusBar{background:var(--bg-secondary);border-top:1px solid var(--border);padding:4px 12px;font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .status-item{display:flex;align-items:center;gap:4px}
  .pill{background:var(--bg-tertiary);border:1px solid var(--border);padding:2px 6px;border-radius:999px}

  /* Diff / Modal */
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
  .modal-content{background:var(--bg-secondary);margin:5% auto;padding:16px;border:1px solid var(--border);border-radius:6px;width:760px;color:var(--text-primary);max-height:80vh;overflow:auto}
  .modal h3{margin:0 0 8px;color:var(--accent)}
  .modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .diff-grid{display:grid;grid-template-columns:1fr 60px 1fr;gap:8px}
  .diff-col{background:var(--bg-primary);padding:6px;border-radius:4px;white-space:pre-wrap;overflow:auto;max-height:260px;min-height:120px}
  .diff-mid{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:flex-start}
  .line{padding:2px 4px;border-radius:4px;margin:1px 0}
  .line.changed{background:rgba(255,255,255,.04)}
  .token.add{background:rgba(76,175,80,.35)}
  .token.del{background:rgba(244,67,54,.35)}
  ::-webkit-scrollbar{width:12px;height:12px}
  ::-webkit-scrollbar-track{background:var(--bg-secondary)}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:6px}
  ::-webkit-scrollbar-thumb:hover{background:var(--text-secondary)}

  /* highlight overlay */
  .highlight-overlay{
    position:absolute; left:50px; right:0; top:0; bottom:0;
    pointer-events:none; white-space:pre-wrap; word-wrap:break-word;
    overflow:hidden; font:inherit; line-height:inherit;
    color:transparent; padding:10px; z-index:1;
  }
  .highlight-overlay mark{ background:rgba(255, 235, 59, .35); border-radius:2px; padding:0; }

  /* Find HUD */
  #findHud{
    position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
    background:var(--bg-secondary); color:var(--text-primary);
    border:1px solid var(--border); border-radius:8px; padding:8px 10px;
    display:none; align-items:center; gap:10px; z-index:2000; font-size:12px;
    box-shadow:0 4px 14px rgba(0,0,0,.25);
  }
  #findHud .btn{cursor:pointer; border:1px solid var(--border); background:var(--bg-tertiary); padding:4px 8px; border-radius:4px}
  #findHud .btn:hover{background:var(--accent); color:#fff}
  #findHud .light{opacity:.8}
</style>
</head>
<body class="light-theme">
  <div id="toolbar">
    <div class="file-input-wrapper">
      <input type="file" id="fileInput" accept=".txt,.js,.html,.css,.py,.json,.xml,.md,.php" multiple>
      <label for="fileInput" class="file-input-label">üìÅ Open</label>
    </div>
    <button onclick="downloadFile()">üíæ Save</button>
    <button onclick="showGotoModal()">üîç Go to Line</button>
    <div class="separator"></div>
    <button onclick="duplicateLine()">üìã Duplicate</button>
    <button onclick="showFindModal()">üîé Find</button>
    <button onclick="clearHighlightsAndHud()">‚úñ Clear Highlight (Esc)</button>
    <div class="separator"></div>
    <label>Font Size:</label><input type="number" id="fontSizeSlider" min="8" max="32" value="14" onchange="changeFontSize(this.value)">
    <label>Theme:</label>
    <select id="themeSelector" onchange="changeTheme(this.value)">
      <option value="light">Light</option><option value="dark">Dark</option>
    </select>
    <div class="separator"></div>
    <button onclick="addPartition()">‚ûï Add Partition</button>
    <button onclick="removeLastPartition()">‚ûñ Remove Last</button>
    <button onclick="equalizePartitions()">‚Üî Equalize</button>
    <label>Layout:</label>
    <select id="layoutSelector" onchange="setLayout(this.value)">
      <option value="row">Side by side</option><option value="column">Stacked</option>
    </select>
    <div class="separator"></div>
    <button onclick="openDiff()">üß© Diff</button>
  </div>

  <div id="main">
    <div id="editor">
      <div id="editorArea">
        <div id="panesContainer"></div>
      </div>
      <div id="tabBar"></div>
    </div>

    <div id="tools">
      <h3>üõ†Ô∏è Tools</h3>
      <h3>Search & Replace</h3>
      <label>Search:</label><input type="text" id="searchBox" placeholder="Search...">
      <label>Replace:</label><input type="text" id="replaceBox" placeholder="Replace with...">
      <label><input type="checkbox" id="regexMode"> Use Regex</label>
      <button id="replaceBtn">Replace All</button>

      <h3>Settings</h3>
      <label><input type="checkbox" id="wordWrap" checked> Word Wrap</label>

      <label>Language:</label>
      <select id="languageSelector">
        <option value="python" selected>Python</option>
        <option value="text">Plain Text</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="json">JSON</option>
        <option value="php">PHP</option>
      </select>

      <label>Comment Style:</label>
      <select id="commentStyle">
        <option value="#" selected>#   (Python, Bash)</option>
        <option value="//">//  (JavaScript, C++)</option>
        <option value="block">/* */ Block (C/JS/PHP/CSS)</option>
        <option value="triple">''' Block (Python)</option>
        <option value="html-block">&lt;!-- --&gt; Block (HTML)</option>
      </select>

      <h3>Code Tools</h3>
      <button onclick="indentSelection()">‚Üí Indent</button>
      <button onclick="unindentSelection()">‚Üê Unindent</button>
      <button onclick="trimWhitespace()">‚úÇÔ∏è Trim Spaces</button>
      <button onclick="convertTabsToSpaces()">üîÑ Tabs‚ÜíSpaces</button>

      <div id="storageStatus">Auto-saving enabled</div>
      <button id="clearAllBtn" onclick="clearAllStorage()">üóëÔ∏è Clear All Data</button>
    </div>
  </div>

  <div id="statusBar">
    <div class="status-item">Line: <span id="currentLine">1</span></div>
    <div class="status-item">Col: <span id="currentCol">1</span></div>
    <div class="status-item">Lines: <span id="totalLines">1</span></div>
    <div class="status-item">Chars: <span id="charCount">0</span></div>
    <div class="status-item pill">Pane: <span id="paneStatus">1/1</span></div>
    <div class="status-item pill">Matches: <span id="matchCount">0</span></div>
  </div>

  <!-- Goto & Find -->
  <div id="gotoModal" class="modal"><div class="modal-content">
    <h3>Go to Line</h3>
    <input type="number" id="gotoLineInput" placeholder="Line number" min="1">
    <div class="row" style="justify-content:flex-end">
      <button onclick="closeModal('gotoModal')">Cancel</button>
      <button onclick="gotoLine()" style="background:var(--accent);color:#fff">Go</button>
    </div>
  </div></div>

  <div id="findModal" class="modal"><div class="modal-content">
    <h3>Find in Document</h3>
    <input type="text" id="findInput" placeholder="Search for...">
    <div class="row" style="justify-content:flex-end">
      <button onclick="closeModal('findModal')">Cancel</button>
      <button onclick="findText()" style="background:var(--accent);color:#fff">Find</button>
    </div>
  </div></div>

  <!-- Diff -->
  <div id="diffModal" class="modal"><div class="modal-content">
    <h3>Pane Diff</h3>
    <div class="row">
      <label>Left Pane:</label><select id="diffLeft"></select>
      <label>Right Pane:</label><select id="diffRight"></select>
      <button onclick="buildDiff()" style="background:var(--accent);color:#fff">Compare</button>
      <span id="diffSummary" class="pill">No comparison</span>
      <div style="flex:1"></div>
      <button onclick="closeModal('diffModal')">Close</button>
    </div>
    <div id="diffList"></div>
  </div></div>

  <!-- Find HUD -->
  <div id="findHud">
    <span id="findHudText">0 matches</span>
    <button class="btn" onclick="findPrev()">Prev</button>
    <button class="btn" onclick="findNext()">Next</button>
    <span class="light">‚Ä¢</span>
    <button class="btn" onclick="clearHighlightsAndHud()">Close</button>
  </div>

<script>
/* =========================
   Config & State
   ========================= */
const INDENT = '   '; // 3 spaces
let tabs=[], activeTabId=null, autoSaveTimeout=null, renamingTabId=null;
const singleClickTimers = new Map();

const panesContainer=document.getElementById('panesContainer');
const tabBar=document.getElementById('tabBar');
const paneStatus=document.getElementById('paneStatus');
const storageStatus=document.getElementById('storageStatus');
const commentStyleSelector=document.getElementById('commentStyle');
const languageSelector=document.getElementById('languageSelector');

const findHud = document.getElementById('findHud');
const findHudText = document.getElementById('findHudText');
let findState = { term:'', lastDir:1 };

const getActiveTab = ()=>tabs.find(t=>t.id===activeTabId);
const px=n=>`${n}px`;
const showModal=id=>document.getElementById(id).style.display='block';
const closeModal=id=>document.getElementById(id).style.display='none';

/* Utils */
function lineHeightPx(el){
  const cs=getComputedStyle(el);
  let lh=parseFloat(cs.lineHeight);
  if(!lh || cs.lineHeight==='normal'){
    const tmp=document.createElement('div');
    tmp.style.position='absolute'; tmp.style.visibility='hidden';
    tmp.style.font=cs.font; tmp.style.whiteSpace='pre';
    tmp.textContent='A\nA';
    document.body.appendChild(tmp);
    lh = tmp.clientHeight/2 || parseFloat(cs.fontSize)*1.5 || 20;
    tmp.remove();
  }
  return lh;
}
function escRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function escHTML(s){ return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

/* Highlight state */
function getHighlightTerm(){ const t=getActiveTab(); return t && (t.highlightTerm || ''); }
function setHighlightTerm(term){
  const t=getActiveTab(); if(!t) return;
  t.highlightTerm = (term || '').trim();
  t.panes.forEach((_, i)=>renderHighlights(i));
  updateMatchCount();
  saveToStorage();
}
function clearHighlights(){ setHighlightTerm(''); }
function clearHighlightsAndHud(){ hideFindHud(true); }

/* =========================
   Storage
   ========================= */
function scheduleAutoSave(){ clearTimeout(autoSaveTimeout); autoSaveTimeout=setTimeout(saveToStorage,600); }
function saveToStorage(){
  try{
    saveCurrentTabContent();
    const toStore=JSON.parse(JSON.stringify(tabs,(k,v)=>k==='bookmarks'&&v instanceof Set?[...v]:v));
    localStorage.setItem('notepadData', JSON.stringify({tabs:toStore,activeTabId}));
    storageStatus.textContent='Saved'; setTimeout(()=>storageStatus.textContent='Auto-saving enabled',1200);
  }catch(e){ console.error(e); storageStatus.textContent='Save failed'; }
}
function loadFromStorage(){
  try{
    const s=localStorage.getItem('notepadData'); if(!s) return false;
    const data=JSON.parse(s);
    tabs=(data.tabs||[]).map(t=>({
      id:t.id,name:t.name||'Untitled',language:t.language||'python',layout:t.layout||'row',
      panes:(t.panes&&t.panes.length?t.panes:[{content:t.content||''}]).map(p=>({content:p.content||'',bookmarks:new Set(p.bookmarks||[])})),
      activePane:typeof t.activePane==='number'?t.activePane:0,
      highlightTerm: t.highlightTerm || ''
    }));
    activeTabId=data.activeTabId || (tabs[0]&&tabs[0].id);
    if(tabs.length){ renderTabs(); switchTab(activeTabId); return true; }
  }catch(e){ console.error(e); }
  return false;
}

/* =========================
   Tabs
   ========================= */
function createTab(name='Untitled', content='', language='python'){
  const id=Date.now().toString();
  tabs.push({id,name,language,layout:'row',panes:[{content,bookmarks:new Set()}],activePane:0,highlightTerm:''});
  renderTabs(); switchTab(id); saveToStorage();
}
function renderTabs(){
  tabBar.innerHTML='';
  tabs.forEach(tab=>{
    const tabEl=document.createElement('div');
    tabEl.className='tab'+(tab.id===activeTabId?' active':'');
    const nameSpan=document.createElement('div');
    nameSpan.className='tab-name';
    nameSpan.textContent=tab.name;
    nameSpan.title=tab.name;

    tabEl.addEventListener('dblclick',(e)=>{
      e.preventDefault(); e.stopPropagation();
      const pending=singleClickTimers.get(tab.id);
      if(pending){ clearTimeout(pending); singleClickTimers.delete(tab.id); }
      startRename(tab, tabEl, nameSpan);
    });
    tabEl.addEventListener('click',(e)=>{
      if(renamingTabId) return;
      if(e.detail !== 1) return;
      const tId=setTimeout(()=>{ switchTab(tab.id); singleClickTimers.delete(tab.id); }, 260);
      singleClickTimers.set(tab.id, tId);
    });

    const closeBtn=document.createElement('div');
    closeBtn.className='close-btn'; closeBtn.textContent='√ó'; closeBtn.title='Close tab';
    closeBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const pending=singleClickTimers.get(tab.id); if(pending){clearTimeout(pending); singleClickTimers.delete(tab.id);} closeTab(tab.id); });

    tabEl.appendChild(nameSpan);
    tabEl.appendChild(closeBtn);
    tabBar.appendChild(tabEl);
  });
  const addBtn=document.createElement('div');
  addBtn.id='addTab'; addBtn.textContent='+'; addBtn.title='Add new tab';
  addBtn.addEventListener('click',()=>createTab(`Tab ${tabs.length+1}`));
  tabBar.appendChild(addBtn);
}
function startRename(tab, tabEl, nameSpan){
  if(renamingTabId) return;
  renamingTabId=tab.id;
  const input=document.createElement('input');
  input.type='text'; input.value=tab.name; input.className='tab-rename';
  input.style.border='1px solid var(--accent)'; input.style.borderRadius='4px';
  input.style.background='var(--bg-primary)'; input.style.color='var(--text-primary)';
  input.style.font='inherit'; input.style.minWidth='120px';
  const commit=()=>{ tab.name=input.value.trim()||tab.name; renamingTabId=null; renderTabs(); saveToStorage(); };
  const cancel=()=>{ renamingTabId=null; renderTabs(); };
  input.addEventListener('blur', commit);
  input.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter') commit(); if(ev.key==='Escape') cancel(); });
  tabEl.replaceChild(input, nameSpan);
  input.focus(); input.select();
}
function closeTab(id){
  if(!confirm('Delete this tab?')) return;
  const i=tabs.findIndex(t=>t.id===id); tabs.splice(i,1);
  if(activeTabId===id){
    const f=tabs[i]||tabs[i-1];
    f?switchTab(f.id):(activeTabId=null, panesContainer.innerHTML='', renderTabs(), createTab('Untitled'));
  }else{ renderTabs(); saveToStorage(); }
}
function switchTab(id){
  saveCurrentTabContent();
  activeTabId=id; const t=getActiveTab(); if(!t) return;
  if(!t.panes.length) t.panes=[{content:'',bookmarks:new Set()}];
  renderPanesForTab(t);
  renderTabs();
  const ta=getActiveTextarea(); if(ta) ta.focus();
  languageSelector.value = t.language || 'python';
  t.panes.forEach((_, i)=>{ syncPaneMetrics(i); updatePane(i); renderHighlights(i); });
  updateAllUI(); scheduleAutoSave();
}

/* =========================
   Panes & layout
   ========================= */
function getActiveTextarea(){
  const t=getActiveTab(); if(!t) return null;
  const idx=t.activePane ?? 0;
  return panesContainer.querySelectorAll('.pane textarea')[idx] || panesContainer.querySelector('.pane textarea');
}
function getPaneNodes(idx){
  const pane=panesContainer.querySelectorAll('.pane')[idx];
  if(!pane) return {};
  return {pane, gutter:pane.querySelector('.gutter'), ta:pane.querySelector('textarea'), hl:pane.querySelector('.current-line-highlight'), ov:pane.querySelector('.highlight-overlay')};
}
function renderPanesForTab(tab){
  panesContainer.innerHTML=''; panesContainer.style.flexDirection=tab.layout||'row';
  tab.panes.forEach((p,idx)=>{
    const pane=document.createElement('div'); pane.className='pane';
    const gutter=document.createElement('div'); gutter.className='gutter'; pane.appendChild(gutter);
    const hl=document.createElement('div'); hl.className='current-line-highlight'; pane.appendChild(hl);
    const overlay=document.createElement('div'); overlay.className='highlight-overlay'; pane.appendChild(overlay);

    const ta=document.createElement('textarea'); ta.value=p.content||'';

    const fs=(document.getElementById('fontSizeSlider').value||14)+'px';
    ta.style.fontSize=fs; gutter.style.fontSize=fs; overlay.style.fontSize=fs;
    const wrap=document.getElementById('wordWrap').checked; 
    ta.style.whiteSpace=wrap?'pre-wrap':'pre'; ta.style.wordWrap=wrap?'break-word':'normal';
    overlay.style.whiteSpace=ta.style.whiteSpace; overlay.style.wordWrap=ta.style.wordWrap;
    const lh=lineHeightPx(ta); ta.style.lineHeight=lh+'px'; gutter.style.lineHeight=lh+'px'; hl.style.height=px(lh); overlay.style.lineHeight=lh+'px';

    ta.addEventListener('scroll', ()=>{ 
      gutter.scrollTop=ta.scrollTop; 
      overlay.scrollTop=ta.scrollTop;
      positionHL(idx); 
    });
    gutter.addEventListener('wheel', (e)=>{ e.preventDefault(); ta.scrollTop += e.deltaY; }, {passive:false});

    ta.addEventListener('input', ()=>{ tab.panes[idx].content=ta.value; updatePane(idx); renderHighlights(idx); if(tab.activePane===idx) updateStatusBar(); scheduleAutoSave(); });
    ta.addEventListener('focus', ()=>{ tab.activePane=idx; updateAllUI(); });
    ta.addEventListener('click', ()=>{ if(tab.activePane!==idx) tab.activePane=idx; updateAllUI(); });
    ta.addEventListener('keyup', ()=>{ updateAllUI(); renderHighlights(idx); });

    ta.addEventListener('dblclick', ()=>{
      const s=ta.selectionStart, e=ta.selectionEnd;
      const w=(ta.value.slice(s,e) || '').trim();
      if(w && /\S/.test(w)){ setHighlightTerm(w); showFindHud(); }
    });

    pane.appendChild(ta); panesContainer.appendChild(pane);
    if(idx<tab.panes.length-1){ const rz=document.createElement('div'); rz.className='resizer'; panesContainer.appendChild(rz); initResizer(rz); }
  });
  if(typeof tab.activePane!=='number'||tab.activePane>=tab.panes.length) tab.activePane=0;
  const ta=getActiveTextarea(); if(ta) ta.focus();
  setLayout(tab.layout||'row');
  tab.panes.forEach((_,i)=>{ updatePane(i); renderHighlights(i); });
}
function initResizer(rz){
  let sx=0,sy=0,prevSize=0,nextSize=0,prevPane,nextPane;
  function down(e){
    e.preventDefault(); const t=getActiveTab(); if(!t) return;
    sx=e.clientX; sy=e.clientY;
    prevPane=rz.previousElementSibling; nextPane=rz.nextElementSibling;
    if(!(prevPane&&nextPane&&prevPane.classList.contains('pane')&&nextPane.classList.contains('pane'))) return;
    const pr=prevPane.getBoundingClientRect(), nr=nextPane.getBoundingClientRect();
    prevSize=(t.layout==='column')?pr.height:pr.width; nextSize=(t.layout==='column')?nr.height:nr.width;
    addEventListener('mousemove',move); addEventListener('mouseup',up);
  }
  function move(e){
    const t=getActiveTab(); if(!t||!prevPane||!nextPane) return;
    const dx=e.clientX-sx, dy=e.clientY-sy, total=prevSize+nextSize;
    if(t.layout==='column'){ const np=Math.max(80,prevSize+dy), nn=Math.max(80,total-np); prevPane.style.flex='0 0 '+px(np); nextPane.style.flex='0 0 '+px(nn); }
    else { const np=Math.max(220,prevSize+dx), nn=Math.max(220,total-np); prevPane.style.flex='0 0 '+px(np); nextPane.style.flex='0 0 '+px(nn); }
  }
  function up(){ removeEventListener('mousemove',move); removeEventListener('mouseup',up); }
  rz.addEventListener('mousedown',down);
}
function setLayout(mode){
  const t=getActiveTab(); if(!t) return;
  t.layout=(mode==='column')?'column':'row';
  panesContainer.style.flexDirection=t.layout;
  panesContainer.querySelectorAll('.resizer').forEach(rz=>{
    const v=t.layout==='column'; rz.classList.toggle('vertical',v); rz.style.width=v?'100%':'6px'; rz.style.height=v?'6px':'auto'; rz.style.cursor=v?'row-resize':'col-resize';
  });
  saveToStorage();
}

/* panes add/remove/equalize */
function addPartition(){
  const t=getActiveTab(); if(!t) return;
  t.panes.push({content:'',bookmarks:new Set()});
  t.activePane=t.panes.length-1;
  renderPanesForTab(t);
  equalizePartitions(); saveToStorage();
}
function removeLastPartition(){
  const t=getActiveTab(); if(!t) return;
  if(t.panes.length<=1) return;
  t.panes.pop();
  if(t.activePane>=t.panes.length) t.activePane=t.panes.length-1;
  renderPanesForTab(t); saveToStorage();
}
function equalizePartitions(){ panesContainer.querySelectorAll('.pane').forEach(p=>{ p.style.flexBasis='0'; p.style.flexGrow='1';}); }

/* =========================
   Gutter + highlight + status
   ========================= */
function syncPaneMetrics(idx){
  const {gutter, ta, hl, ov} = getPaneNodes(idx);
  if(!gutter || !ta || !hl) return;

  const fs = getComputedStyle(ta).fontSize;
  gutter.style.fontSize = fs;
  if(ov) ov.style.fontSize = fs;

  const lh = lineHeightPx(ta);
  ta.style.lineHeight = lh + 'px';
  gutter.style.lineHeight = lh + 'px';
  hl.style.height = lh + 'px';
  if(ov) ov.style.lineHeight = lh + 'px';

  const cs = getComputedStyle(ta);
  gutter.style.paddingTop = cs.paddingTop;
  gutter.style.paddingBottom = cs.paddingBottom;

  if(ov){
    ov.style.paddingTop = cs.paddingTop;
    ov.style.paddingBottom = cs.paddingBottom;
    ov.style.paddingLeft = cs.paddingLeft;
    ov.style.paddingRight = cs.paddingRight;
    ov.style.whiteSpace = ta.style.whiteSpace;
    ov.style.wordWrap = ta.style.wordWrap;
    ov.scrollTop = ta.scrollTop;
  }
  gutter.scrollTop = ta.scrollTop;
}
function updatePane(idx){
  const t=getActiveTab(); const {ta,gutter}=getPaneNodes(idx); if(!ta||!gutter) return;
  syncPaneMetrics(idx);
  const lines=ta.value.split('\n');
  const caretLine = ta.value.substring(0,ta.selectionStart).split('\n').length;
  let html='';
  const lh=parseFloat(getComputedStyle(ta).lineHeight);
  for(let n=1;n<=lines.length;n++){
    const cls = n===caretLine ? 'line-number current-line' : 'line-number';
    html += `<span class="${cls}" style="display:block;height:${lh}px;line-height:${lh}px" data-line="${n}">${n}</span>`;
  }
  gutter.innerHTML=html;
  gutter.scrollTop = ta.scrollTop;
  positionHL(idx);
  renderHighlights(idx);
}
function positionHL(idx){
  const {ta,hl}=getPaneNodes(idx); if(!ta||!hl) return;
  const lh=lineHeightPx(ta);
  const current=ta.value.substring(0,ta.selectionStart).split('\n').length-1;
  const pt=parseFloat(getComputedStyle(ta).paddingTop)||0;
  const top=pt + current*lh - ta.scrollTop;
  hl.style.top=px(top); hl.style.display='block';
}
function updateStatusBar(){
  const ta=getActiveTextarea(); const t=getActiveTab(); if(!ta||!t) return;
  const pos=ta.selectionStart, textBefore=ta.value.substring(0,pos);
  document.getElementById('currentLine').textContent=textBefore.split('\n').length;
  document.getElementById('currentCol').textContent=textBefore.split('\n').pop().length+1;
  document.getElementById('totalLines').textContent=ta.value.split('\n').length;
  document.getElementById('charCount').textContent=ta.value.length;
  paneStatus.textContent=`${(t.activePane??0)+1}/${t.panes.length}`;
  updateMatchCount();
}
function updateAllUI(){ const t=getActiveTab(); if(t) updatePane(t.activePane); updateStatusBar(); }

/* highlight rendering & match count */
function renderHighlights(idx){
  const term=getHighlightTerm(); const {ov,ta}=getPaneNodes(idx);
  if(!ov || !ta) return;
  if(!term){ ov.innerHTML=''; return; }
  try{
    const re=new RegExp(escRe(term),'g');
    const html=escHTML(ta.value).replace(re, m=>`<mark>${m}</mark>`);
    ov.innerHTML=html;
    ov.scrollTop=ta.scrollTop;
  }catch(e){ ov.innerHTML=''; }
}
function updateMatchCount(){
  const t=getActiveTab(); if(!t){ document.getElementById('matchCount').textContent='0'; return; }
  const term=getHighlightTerm();
  if(!term){ document.getElementById('matchCount').textContent='0'; findHudText.textContent='0 matches'; return; }
  const re=new RegExp(escRe(term),'g');
  let total=0, paneTotal=0;
  t.panes.forEach((p,i)=>{
    const m=(p.content||'').match(re);
    const c=m?m.length:0; total+=c; if(i===t.activePane) paneTotal=c;
  });
  document.getElementById('matchCount').textContent=String(total);
  findHudText.textContent = `${paneTotal} in pane ‚Ä¢ ${total} total`;
}

/* =========================
   File / Find / Goto / Replace
   ========================= */
function downloadFile(){
  const t=getActiveTab(); if(!t) return; saveCurrentTabContent();
  const i=t.activePane??0; const content=(t.panes[i]&&t.panes[i].content)||'';
  const blob=new Blob([content],{type:'text/plain'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${t.name}-pane${i+1}.txt`; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('fileInput').addEventListener('change',e=>{
  Array.from(e.target.files).forEach(file=>{
    const r=new FileReader();
    r.onload=ev=>createTab(file.name, ev.target.result, languageSelector.value || 'python');
    r.readAsText(file);
  });
});
function showGotoModal(){ showModal('gotoModal'); document.getElementById('gotoLineInput').focus(); }
function gotoLine(){
  const ta=getActiveTextarea(); const n=parseInt(document.getElementById('gotoLineInput').value); if(!ta||!(n>0)) return closeModal('gotoModal');
  const lines=ta.value.split('\n'); if(n<=lines.length){ const pos=lines.slice(0,n-1).join('\n').length+(n>1?1:0); ta.selectionStart=ta.selectionEnd=pos; ta.focus(); updateAllUI(); }
  closeModal('gotoModal');
}
function showFindModal(){ showModal('findModal'); document.getElementById('findInput').focus(); }
function findText(){
  const ta=getActiveTextarea(); const s=document.getElementById('findInput').value; closeModal('findModal');
  if(!ta || !s){ return; }
  setHighlightTerm(s);
  findState.term = s;
  selectNextOccurrence(1);
  showFindHud();
}
document.getElementById('replaceBtn').addEventListener('click',()=>{
  const ta=getActiveTextarea(); if(!ta) return;
  const search=document.getElementById('searchBox').value;
  const replace=document.getElementById('replaceBox').value;
  const useRegex=document.getElementById('regexMode').checked;
  if(!search) return;
  try{
    const re = useRegex ? new RegExp(search,'g') : new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
    ta.value = ta.value.replace(re, replace);
    const t=getActiveTab(); if(t) t.panes[t.activePane].content=ta.value;
    setHighlightTerm(search);
    updateAllUI(); scheduleAutoSave();
    showFindHud();
  }catch(e){ alert('Invalid regex'); }
});

/* Find HUD helpers */
function showFindHud(){ findHud.style.display='flex'; updateMatchCount(); }
function hideFindHud(clear=false){
  findHud.style.display='none';
  if(clear){ clearHighlights(); updateAllUI(); }
}
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    if(findHud.style.display!=='none'){ e.preventDefault(); hideFindHud(true); }
  }
});
function findNext(){ findState.lastDir=1; selectNextOccurrence(1); }
function findPrev(){ findState.lastDir=-1; selectNextOccurrence(-1); }
function selectNextOccurrence(dir){
  const ta=getActiveTextarea(); const term=getHighlightTerm(); if(!ta||!term) return;
  const content=ta.value;
  if(dir===1){
    const start = ta.selectionEnd ?? 0;
    const i = content.indexOf(term, start);
    const pos = (i!==-1) ? i : content.indexOf(term, 0);
    if(pos!==-1){ ta.selectionStart=pos; ta.selectionEnd=pos+term.length; ta.focus(); ensureVisible(ta); }
  }else{
    const start = (ta.selectionStart ?? content.length);
    const before = content.slice(0, Math.max(0,start-term.length));
    const pos = before.lastIndexOf(term);
    const wrapped = (pos===-1) ? content.lastIndexOf(term) : pos;
    if(wrapped!==-1){ ta.selectionStart=wrapped; ta.selectionEnd=wrapped+term.length; ta.focus(); ensureVisible(ta); }
  }
  updateMatchCount();
}
function ensureVisible(ta){
  const pos=ta.selectionStart;
  const textUpToPos=ta.value.slice(0,pos);
  const lineIndex=textUpToPos.split('\n').length-1;
  const lh=lineHeightPx(ta);
  const pt=parseFloat(getComputedStyle(ta).paddingTop)||0;
  const lineTop=lineIndex*lh;
  const viewTop=ta.scrollTop;
  const viewBot=ta.scrollTop + ta.clientHeight - lh;
  if(lineTop < viewTop) ta.scrollTop = Math.max(0, lineTop - lh*2);
  else if(lineTop > viewBot) ta.scrollTop = lineTop - (ta.clientHeight - lh*3);
}

/* =========================
   Commenting: safe style map
   ========================= */
const COMMENT_STYLES = {
  '#':        { kind:'line', token:'#' },
  '//':       { kind:'line', token:'//' },
  'block':    { kind:'block', open:'/*',  close:'*/' },
  'triple':   { kind:'block', open:"'''", close:"'''" },
  'html-block': { kind:'block', open:'<!--', close:'-->' }
};

function toggleComment(){
  const ta=getActiveTextarea(); if(!ta) return;
  const pick = COMMENT_STYLES[commentStyleSelector.value] || COMMENT_STYLES['#'];
  const s=ta.selectionStart, e=ta.selectionEnd, v=ta.value;
  const selected=v.slice(s,e);
  const before=v.slice(0,s), after=v.slice(e);

  if(pick.kind==='block'){
    const {open, close}=pick;
    const trimmed=selected.trim();
    if(trimmed.startsWith(open) && trimmed.endsWith(close)){
      // unwrap (search within selection to preserve leading/trailing space)
      const start = selected.indexOf(open);
      const end = selected.lastIndexOf(close);
      const inner = selected.slice(0,start) + selected.slice(start+open.length, end) + selected.slice(end+close.length);
      ta.value = before + inner + after;
      ta.selectionStart = s; ta.selectionEnd = s + inner.length;
    }else{
      const isSingleLine = !selected.includes('\n');
      const block = isSingleLine ? `${open} ${selected} ${close}` : `${open}\n${selected}\n${close}`;
      ta.value = before + block + after;
      const offset = isSingleLine ? open.length + 1 : open.length + 1;
      ta.selectionStart = s + offset; ta.selectionEnd = s + offset + selected.length;
    }
    updateAllUI(); scheduleAutoSave(); return;
  }

  // line comments
  const token = pick.token;
  if(selected.includes('\n')){
    const lines=selected.split('\n');
    const allCommented = lines.every(l=>l.trim()==='' || l.trim().startsWith(token));
    const out = lines.map(l=>{
      if(l.trim()==='') return l;
      if(allCommented){
        const re = new RegExp('^(\\s*)'+escRe(token)+'\\s?');
        return l.replace(re,'$1');
      }else{
        return l.replace(/^(\s*)/, `$1${token} `);
      }
    }).join('\n');
    ta.value = before + out + after;
    ta.selectionStart=s; ta.selectionEnd=s+out.length;
  }else{
    const ls=v.lastIndexOf('\n',s-1)+1, le=v.indexOf('\n',s); const end = le===-1? v.length : le;
    const line=v.slice(ls,end);
    const re = new RegExp('^(\\s*)'+escRe(token)+'\\s?');
    let newLine;
    if(line.trim().startsWith(token)){ newLine=line.replace(re,'$1'); }
    else{ newLine=line.replace(/^(\s*)/, `$1${token} `); }
    ta.value = v.slice(0,ls)+newLine+v.slice(end);
    const delta = newLine.length - line.length;
    ta.selectionStart = ta.selectionEnd = s + delta;
  }
  updateAllUI(); scheduleAutoSave();
}

/* Convert selection to the style chosen (if there‚Äôs a selection) */
commentStyleSelector.addEventListener('change', ()=>{
  const ta=getActiveTextarea(); if(!ta) return;
  if(ta.selectionStart===ta.selectionEnd) return;
  recommentSelection(commentStyleSelector.value);
});

function recommentSelection(styleKey){
  const ta=getActiveTextarea(); if(!ta) return;
  const pick = COMMENT_STYLES[styleKey] || COMMENT_STYLES['#'];
  const s=ta.selectionStart, e=ta.selectionEnd, v=ta.value;
  let sel=v.slice(s,e), before=v.slice(0,s), after=v.slice(e);

  // strip block wrappers
  [['/*','*/'], ["'''","'''"], ['<!--','-->']].forEach(([o,c])=>{
    const t=sel.trim();
    if(t.startsWith(o) && t.endsWith(c)){
      const start=sel.indexOf(o), end=sel.lastIndexOf(c);
      sel = sel.slice(0,start) + sel.slice(start+o.length, end) + sel.slice(end+c.length);
    }
  });
  // strip line prefixes
  sel = sel.split('\n').map(l=> l.replace(/^(\s*)#\s?/, '$1').replace(/^(\s*)\/\/\s?/, '$1')).join('\n');

  if(pick.kind==='block'){
    const {open, close}=pick;
    const block = sel.includes('\n') ? `${open}\n${sel}\n${close}` : `${open} ${sel} ${close}`;
    ta.value = before + block + after;
    ta.selectionStart = s + (sel.includes('\n') ? open.length+1 : open.length+1);
    ta.selectionEnd = ta.selectionStart + sel.length;
  }else{
    const token = pick.token;
    const out = sel.split('\n').map(l=> l.trim()==='' ? l : `${token} ${l}`).join('\n');
    ta.value = before + out + after;
    ta.selectionStart = s; ta.selectionEnd = s + out.length;
  }
  updateAllUI(); scheduleAutoSave();
}

/* =========================
   Editing / Indent & Comment (multi-language aware)
   ========================= */
document.addEventListener('keydown', e=>{
  const ta=getActiveTextarea(); if(!ta) return;

  // Ctrl+/ toggles using the currently selected style
  if((e.ctrlKey||e.metaKey) && e.key==='/'){ e.preventDefault(); toggleComment(); return; }

  // Tab / Shift+Tab
  if(e.key==='Tab' && !e.shiftKey){
    e.preventDefault();
    const s=ta.selectionStart, ePos=ta.selectionEnd, v=ta.value;
    if(s!==ePos){ indentSelection(); }
    else { ta.value=v.slice(0,s)+INDENT+v.slice(ePos); ta.selectionStart=ta.selectionEnd=s+INDENT.length; }
    updateAllUI(); scheduleAutoSave(); return;
  }
  if(e.key==='Tab' && e.shiftKey){
    e.preventDefault(); unindentSelection(); updateAllUI(); scheduleAutoSave(); return;
  }

  // Enter with auto-indent (Python, PHP, JS, CSS, JSON)
  if(e.key==='Enter'){
    e.preventDefault();
    const sPos=ta.selectionStart, ePos=ta.selectionEnd, v=ta.value;
    const before=v.slice(0,sPos), after=v.slice(ePos);
    const lastLine=before.split('\n').pop();
    const baseIndent=(lastLine.match(/^\s*/)||[''])[0];

    const t=getActiveTab(); const lang=(t && t.language) || languageSelector.value || 'python';
    let extra = '';
    const trimmed = lastLine.trimEnd();

    /* Python */
    if(lang==='python'){ if(trimmed.endsWith(':')) extra=INDENT; }

    /* PHP */
    if(lang==='php'){
      if(/<\?(?:php|=)?\s*$/i.test(trimmed)) extra = INDENT;        // after <?, <?php, <?= 
      if(/\{\s*(\/\/.*)?$/.test(trimmed)) extra = INDENT;           // after {
      if(/\b(if|elseif|else|foreach|for|while|switch|declare)\b[^{;]*:\s*(\/\/.*)?$/i.test(trimmed)) extra = INDENT; // alt syntax :
      const closeAhead = after.match(/^\s*\}/);
      if(closeAhead){
        const reduced = baseIndent.endsWith(INDENT) ? baseIndent.slice(0,-INDENT.length) : baseIndent.replace(/^ {1,2}$/,'');
        ta.value = before + '\n' + reduced + after;
        ta.selectionStart = ta.selectionEnd = sPos + 1 + reduced.length;
        updateAllUI(); scheduleAutoSave(); return;
      }
    }

    /* JavaScript */
    if(lang==='javascript'){
      if(/\{\s*(\/\/.*)?$/.test(trimmed)) extra = INDENT;
      if(/^\s*(case\b.+:|default:)\s*(\/\/.*)?$/.test(lastLine)) extra = INDENT;
      const closeAhead = after.match(/^\s*\}/);
      if(closeAhead){
        const reduced = baseIndent.endsWith(INDENT) ? baseIndent.slice(0,-INDENT.length) : baseIndent.replace(/^ {1,2}$/,'');
        ta.value = before + '\n' + reduced + after;
        ta.selectionStart = ta.selectionEnd = sPos + 1 + reduced.length;
        updateAllUI(); scheduleAutoSave(); return;
      }
    }

    /* CSS */
    if(lang==='css'){
      if(/\{\s*$/.test(trimmed)) extra = INDENT;
      const closeAhead = after.match(/^\s*\}/);
      if(closeAhead){
        const reduced = baseIndent.endsWith(INDENT) ? baseIndent.slice(0,-INDENT.length) : baseIndent.replace(/^ {1,2}$/,'');
        ta.value = before + '\n' + reduced + after;
        ta.selectionStart = ta.selectionEnd = sPos + 1 + reduced.length;
        updateAllUI(); scheduleAutoSave(); return;
      }
    }

    /* JSON */
    if(lang==='json'){
      if(/\{\s*$/.test(trimmed) || /\[\s*$/.test(trimmed)) extra = INDENT;
      const closeAhead = after.match(/^\s*[\}\]]/);
      if(closeAhead){
        const reduced = baseIndent.endsWith(INDENT) ? baseIndent.slice(0,-INDENT.length) : baseIndent.replace(/^ {1,2}$/,'');
        ta.value = before + '\n' + reduced + after;
        ta.selectionStart = ta.selectionEnd = sPos + 1 + reduced.length;
        updateAllUI(); scheduleAutoSave(); return;
      }
    }

    ta.value = before + '\n' + baseIndent + extra + after;
    ta.selectionStart = ta.selectionEnd = sPos + 1 + baseIndent.length + extra.length;
    updateAllUI(); scheduleAutoSave(); return;
  }

  // Smart backspace: eat one INDENT at boundary
  if(e.key==='Backspace' && ta.selectionStart===ta.selectionEnd){
    const sPos=ta.selectionStart, v=ta.value;
    const lineStart = v.lastIndexOf('\n', sPos-1) + 1;
    const toCursor = v.slice(lineStart, sPos);
    if(toCursor.endsWith(INDENT)){
      e.preventDefault();
      ta.value = v.slice(0, sPos-INDENT.length) + v.slice(sPos);
      ta.selectionStart = ta.selectionEnd = sPos - INDENT.length;
      updateAllUI(); scheduleAutoSave(); return;
    }
  }
});

/* Indent helpers */
function indentSelection(){
  const ta=getActiveTextarea(); if(!ta) return;
  const s=ta.selectionStart,e=ta.selectionEnd,v=ta.value,sel=v.slice(s,e);
  if(sel.includes('\n')){
    const lines=sel.split('\n');
    const out=lines.map(l=>INDENT+l).join('\n');
    ta.value=v.slice(0,s)+out+v.slice(e);
    ta.selectionStart=s; ta.selectionEnd=e + lines.length*INDENT.length;
  }else{
    ta.value=v.slice(0,s)+INDENT+v.slice(s);
    ta.selectionStart=ta.selectionEnd=s+INDENT.length;
  }
}
function unindentSelection(){
  const ta=getActiveTextarea(); if(!ta) return;
  const s=ta.selectionStart,e=ta.selectionEnd,v=ta.value,sel=v.slice(s,e);
  const rm = (line)=> line.startsWith(INDENT) ? line.slice(INDENT.length) : line.replace(/^ {1,2}$/, '');
  if(sel.includes('\n')){
    const lines=sel.split('\n');
    const out=lines.map(rm).join('\n');
    ta.value=v.slice(0,s)+out+v.slice(e);
    ta.selectionStart=s; ta.selectionEnd=s+out.length;
  }else{
    const ls=v.lastIndexOf('\n',s-1)+1, le=v.indexOf('\n',s); const line=v.slice(ls, le===-1?v.length:le);
    if(line.startsWith(INDENT)){
      ta.value=v.slice(0,ls)+line.slice(INDENT.length)+v.slice(le===-1?v.length:le);
      ta.selectionStart=ta.selectionEnd=s-INDENT.length;
    }
  }
}
function duplicateLine(){
  const ta=getActiveTextarea(); if(!ta) return;
  const s=ta.selectionStart, e=ta.selectionEnd, v=ta.value;
  const lineStart=v.lastIndexOf('\n', s-1)+1;
  const lineEnd=v.indexOf('\n', e); const end = lineEnd===-1? v.length : lineEnd;
  const line=v.slice(lineStart, end);
  ta.value = v.slice(0,end) + '\n' + line + v.slice(end);
  ta.selectionStart = ta.selectionEnd = end + 1 + line.length;
  updateAllUI(); scheduleAutoSave();
}

/* =========================
   Persist current tab panes
   ========================= */
function saveCurrentTabContent(){
  const t=getActiveTab(); if(!t) return;
  const panes=panesContainer.querySelectorAll('.pane');
  t.panes=Array.from(panes).map((p,i)=>({content:p.querySelector('textarea').value,bookmarks:t.panes[i]?t.panes[i].bookmarks:new Set()}));
}

/* =========================
   Diff
   ========================= */
function openDiff(){
  const t=getActiveTab(); if(!t) return;
  const L=document.getElementById('diffLeft'), R=document.getElementById('diffRight');
  L.innerHTML=''; R.innerHTML='';
  t.panes.forEach((_,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`Pane ${i+1}`; L.appendChild(o.cloneNode(true)); R.appendChild(o); });
  L.value=t.activePane; R.value=Math.min(t.activePane+1, t.panes.length-1);
  document.getElementById('diffList').innerHTML=''; document.getElementById('diffSummary').textContent='No comparison';
  document.getElementById('diffModal').style.display='block';
}
function buildDiff(){
  const t=getActiveTab(); if(!t) return;
  const L=parseInt(document.getElementById('diffLeft').value), R=parseInt(document.getElementById('diffRight').value);
  if(L===R){ document.getElementById('diffSummary').textContent='Choose two different panes'; return; }
  const left=t.panes[L].content.split('\n'), right=t.panes[R].content.split('\n');
  const max=Math.max(left.length,right.length);
  const list=document.getElementById('diffList'); list.innerHTML='';

  const grid=document.createElement('div'); grid.className='diff-grid';
  const leftCol=document.createElement('div'); leftCol.className='diff-col';
  const mid=document.createElement('div'); mid.className='diff-mid';
  const rightCol=document.createElement('div'); rightCol.className='diff-col';

  let changed=0;
  for(let i=0;i<max;i++){
    const l=left[i]??'', r=right[i]??'';
    const same = l===r;
    const Lline=document.createElement('div'); Lline.className='line'+(same?'':' changed');
    const Rline=document.createElement('div'); Rline.className='line'+(same?'':' changed');
    if(same){ Lline.textContent=l; Rline.textContent=r; mid.appendChild(document.createElement('div')); }
    else{
      changed++;
      const td=tokenDiff(l,r);
      Lline.innerHTML=td.leftHTML; Rline.innerHTML=td.rightHTML;
      const ctl=document.createElement('div'); ctl.style.display='flex'; ctl.style.flexDirection='column'; ctl.style.gap='6px'; ctl.style.alignItems='center';
      const toLeft=document.createElement('button'); toLeft.textContent='‚Üê'; toLeft.title='Copy right line to left';
      toLeft.onclick=()=>{ left.splice(i, l?1:0, r); t.panes[L].content=left.join('\n'); refreshPane(L); buildDiff(); };
      const toRight=document.createElement('button'); toRight.textContent='‚Üí'; toRight.title='Copy left line to right';
      toRight.onclick=()=>{ right.splice(i, r?1:0, l); t.panes[R].content=right.join('\n'); refreshPane(R); buildDiff(); };
      ctl.appendChild(toLeft); ctl.appendChild(toRight);
      mid.appendChild(ctl);
    }
    leftCol.appendChild(Lline); rightCol.appendChild(Rline);
  }
  grid.appendChild(leftCol); grid.appendChild(mid); grid.appendChild(rightCol);
  list.appendChild(grid);
  document.getElementById('diffSummary').textContent=`${changed} changed line(s)`;
}
function tokenDiff(L,R){
  const lt=L.split(/(\s+)/), rt=R.split(/(\s+)/);
  const n=lt.length,m=rt.length;
  const dp=Array(n+1).fill(0).map(()=>Array(m+1).fill(0));
  for(let i=n-1;i>=0;i--) for(let j=m-1;j>=0;j--) dp[i][j]=lt[i]===rt[j]?dp[i+1][j+1]+1:Math.max(dp[i+1][j],dp[i][j+1]);
  let i=0,j=0, Lhtml='', Rhtml='';
  const esc=s=>s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  while(i<n||j<m){
    if(i<n&&j<m&&lt[i]===rt[j]){ Lhtml+=esc(lt[i]); Rhtml+=esc(rt[j]); i++; j++; }
    else if(j<m && (i===n || dp[i][j+1]>=dp[i+1][j])){ Rhtml+=`<span class="token add">${esc(rt[j])}</span>`; j++; }
    else { Lhtml+=`<span class="token del">${esc(lt[i])}</span>`; i++; }
  }
  return {leftHTML:Lhtml,rightHTML:Rhtml};
}
function refreshPane(idx){
  const t=getActiveTab(); const pane=panesContainer.querySelectorAll('.pane')[idx]; if(!pane) return;
  const ta=pane.querySelector('textarea'); ta.value=t.panes[idx].content||''; updatePane(idx); saveToStorage();
}

/* =========================
   Theme / Font / Wrap / Language
   ========================= */
function changeTheme(theme){ document.body.classList.toggle('light-theme', theme==='light'); }
function changeFontSize(size){
  panesContainer.querySelectorAll('.pane').forEach((p,i)=>{
    const ta=p.querySelector('textarea'); const g=p.querySelector('.gutter'); const ov=p.querySelector('.highlight-overlay');
    ta.style.fontSize=size+'px'; g.style.fontSize=size+'px'; if(ov) ov.style.fontSize=size+'px';
    syncPaneMetrics(i);
    updatePane(i);
  });
  const t=getActiveTab(); if(t) updatePane(t.activePane);
}
document.getElementById('wordWrap').addEventListener('change',e=>{
  const wrap=e.target.checked;
  panesContainer.querySelectorAll('.pane').forEach((p,i)=>{
    const ta=p.querySelector('textarea'); const ov=p.querySelector('.highlight-overlay');
    ta.style.whiteSpace=wrap?'pre-wrap':'pre'; ta.style.wordWrap=wrap?'break-word':'normal';
    if(ov){ ov.style.whiteSpace=ta.style.whiteSpace; ov.style.wordWrap=ta.style.wordWrap; }
    syncPaneMetrics(i);
    updatePane(i);
  });
});
languageSelector.addEventListener('change', (e)=>{
  const t=getActiveTab(); if(!t) return;
  t.language = e.target.value || 'python';
  saveToStorage();
});

/* =========================
   Persist current tab panes
   ========================= */
function saveCurrentTabContent(){
  const t=getActiveTab(); if(!t) return;
  const panes=panesContainer.querySelectorAll('.pane');
  t.panes=Array.from(panes).map((p,i)=>({content:p.querySelector('textarea').value,bookmarks:t.panes[i]?t.panes[i].bookmarks:new Set()}));
}

/* =========================
   Init
   ========================= */
window.addEventListener('beforeunload', saveToStorage);
setInterval(saveToStorage,30000);
addEventListener('resize', () => {
  const t=getActiveTab(); if(!t) return;
  t.panes.forEach((_, i)=>{ syncPaneMetrics(i); updatePane(i); renderHighlights(i); });
});
function clearAllStorage(){
  if(confirm('Clear all saved tabs and data?')){
    localStorage.removeItem('notepadData');
    tabs=[]; activeTabId=null; panesContainer.innerHTML=''; tabBar.innerHTML='';
    createTab('Untitled');
  }
}
function trimWhitespace(){
  const ta=getActiveTextarea(); if(!ta) return;
  ta.value = ta.value.replace(/[ \t]+$/gm,''); updateAllUI(); scheduleAutoSave();
}
function convertTabsToSpaces(){
  const ta=getActiveTextarea(); if(!ta) return;
  ta.value = ta.value.replace(/\t/g, INDENT); updateAllUI(); scheduleAutoSave();
}
function init(){ if(!loadFromStorage()) createTab('Untitled'); updateAllUI(); }
init();
</script>
</body>
</html>
